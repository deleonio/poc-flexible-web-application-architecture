# sudo: true
language: node_js
node_js:
  - "lts/*"
cache:
#   Caches $HOME/.npm when npm ci is default script command
#   Caches node_modules in all other cases
  yarn: true
  directories:
    - ~/.cache
    - ~/.npm
    - ./node_modules
    - ./yarn.lock
  override:
    - yarn
    - yarn upgrade
addons:
  chrome: stable
  apt:
    packages:
#     Ubuntu 16+ does not install this dependency by default, so we need to install it ourselves
    - libgconf-2-4
notifications:
  email:
    on_success: change
    on_failure: always
# https://yarnpkg.com/lang/en/docs/install-ci/
before_install: # if "install" is overridden
#   Repo for Yarn
  - sudo apt-key adv --fetch-keys http://dl.yarnpkg.com/debian/pubkey.gpg
  - echo "deb http://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
  - sudo apt-get update -qq
  - sudo apt-get install -y -qq yarn
#   - sudo apt-get install sshpass
install:
  - yarn
  - yarn upgrade
script:
  - prettier --check src/**/*.html src/**/*.js src/**/*.json src/**/*.jsx src/**/*.ts src/**/*.tsx src/**/*.vue
  - tslint src/**/*.ts src/**/*.tsx
  - yarn coverage
  - nyarn coveralls
  - yarn e2e -e headless
  - yarn build-all
#   - export SSHPASS=${SFTP_PASSWORD}
#   - sshpass -e sftp -oBatchMode=no -b batchfile.sftp ${SFTP_USER}@${SFTP_HOST}:poc
#   - curl --ftp-create-dirs -T dist/angular.js sftp://${SFTP_USER}:${SFTP_PASSWORD}@${SFTP_HOST}/poc/angular.js
# deploy:
#   skip_cleanup: true
#   provider: script
#   script: bash scripts/deploy.sh
#   on:
#     all_branches: true
# after_success:
#   - ssh -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" ${SFTP_USER}@${SFTP_HOST}
#   - export SSHPASS=${SFTP_PASSWORD}
#   - sshpass -e sftp -oBatchMode=no -b scripts/batchfile.sftp ${SFTP_USER}@${SFTP_HOST}:poc
